import tkinter as tk
from tkinter import ttk
from tkinter import messagebox
import sqlite3 as sql


def add_task():
    task_string = task_field.get()
    if len(task_string) == 0:
        messagebox.showinfo('Error', 'Field is Empty.')
    else:
        tasks.append((task_string, 0))
        the_cursor.execute(
            'insert into tasks values (?, ?)',
            (task_string, 0)
        )
        list_update()
        task_field.delete(0, 'end')


def list_update():
    clear_list()
    for task, status in tasks:
        status_text = "Done" if status == 1 else "Pending"
        task_tree.insert('', 'end', values=(task, status_text))


def delete_task():
    try:
        selected = task_tree.focus()
        task, status = task_tree.item(selected, 'values')

        tasks[:] = [t for t in tasks if t[0] != task]
        the_cursor.execute('delete from tasks where title = ?', (task,))
        list_update()

    except:
        messagebox.showinfo('Error', 'No Task Selected.')


def delete_all_tasks():
    if messagebox.askyesno('Delete All', 'Are you sure?'):
        tasks.clear()
        the_cursor.execute('delete from tasks')
        list_update()


def toggle_task():
    selected = task_tree.focus()
    if not selected:
        messagebox.showinfo("Error", "Select a task")
        return

    task, status = task_tree.item(selected, 'values')
    new_status = 0 if status == "Done" else 1

    for i in range(len(tasks)):
        if tasks[i][0] == task:
            tasks[i] = (task, new_status)

    the_cursor.execute(
        'update tasks set completed=? where title=?',
        (new_status, task)
    )
    list_update()


def clear_list():
    for item in task_tree.get_children():
        task_tree.delete(item)


def close():
    guiWindow.destroy()


def retrieve_database():
    tasks.clear()
    for row in the_cursor.execute('select title, completed from tasks'):
        tasks.append((row[0], row[1]))



if __name__ == "__main__":
    guiWindow = tk.Tk()
    guiWindow.title("Daily To-Do List")
    guiWindow.geometry("700x600")
    guiWindow.resizable(0, 0)
    guiWindow.configure(bg="#FAEBD7")

    # Database
    the_connection = sql.connect('listOfTasks.db')
    the_cursor = the_connection.cursor()
    the_cursor.execute(
        'create table if not exists tasks (title text, completed integer)'
    )

    tasks = []

    # Frames
    header_frame = tk.Frame(guiWindow, bg="light blue")
    functions_frame = tk.Frame(guiWindow, bg="light blue")
    listbox_frame = tk.Frame(guiWindow, bg="light blue")

    header_frame.pack(fill="both")
    functions_frame.pack(side="left", expand=True, fill="both")
    listbox_frame.pack(side="right", expand=True, fill="both")

    # Header
    header_label = ttk.Label(
        header_frame,
        text="To-Do List",
        font=("Arial", 28, "bold"),
        background="light blue",
        foreground="white"
    )
    header_label.pack(padx=10, pady=10)

    # Entry
    task_label = ttk.Label(
        functions_frame,
        text="Enter Task:",
        font=("Arial", 11, "bold")
    )
    task_label.place(x=30, y=40)

    task_field = ttk.Entry(
        functions_frame,
        font=("Consolas", 12),
        width=18
    )
    task_field.place(x=30, y=80)

    # Buttons
    add_button = ttk.Button(
        functions_frame,
        text="Add Task",
        width=24,
        command=add_task
    )

    del_button = ttk.Button(
        functions_frame,
        text="Delete Task",
        width=24,
        command=delete_task
    )

    complete_button = ttk.Button(
        functions_frame,
        text="Mark Completed / Undo",
        width=24,
        command=toggle_task
    )

    exit_button = ttk.Button(
        functions_frame,
        text="Exit",
        width=24,
        command=close
    )

    add_button.place(x=30, y=120)
    del_button.place(x=30, y=160)
    complete_button.place(x=30, y=200)
    exit_button.place(x=30, y=240)

    # Treeview (Checkbox Effect)
    task_tree = ttk.Treeview(
        listbox_frame,
        columns=("Task", "Status"),
        show="headings",
        height=13
    )

    task_tree.heading("Task", text="Task")
    task_tree.heading("Status", text="Completed")

    task_tree.column("Task", width=200)
    task_tree.column("Status", width=80)

    task_tree.place(x=10, y=20)

    retrieve_database()
    list_update()

    guiWindow.mainloop()

    the_connection.commit()
    the_cursor.close() 
